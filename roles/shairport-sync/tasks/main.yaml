---
- name: Get current volume setting
  ansible.builtin.shell:
    cmd: amixer sget Headphone | awk -F"[][]" '/Mono:/ { print $2 }'
  changed_when: false
  register: current_volume
  tags: [shairport-sync]

- name: Set alsa volume to 100%
  ansible.builtin.raw: amixer set 'Headphone' 100%
  when: current_volume.stdout != '100%'
  tags: [shairport-sync]

- name: Install necessary libraries
  ansible.builtin.apt:
    pkg:
      - build-essential
      - git
      - autoconf
      - automake
      - libtool
      - libpopt-dev
      - libconfig-dev
      - libasound2-dev
      - avahi-daemon
      - libavahi-client-dev
      - libssl-dev
      - libsoxr-dev
      - libplist-dev
      - libsodium-dev
      - libavutil-dev
      - libavcodec-dev
      - libavformat-dev
      - uuid-dev
      - libgcrypt-dev
      - xxd
    state: present
    install_recommends: false
  become: true
  tags: [shairport-sync, packages]

- name: Clone nqptp repo  # noqa: latest
  ansible.builtin.git:
    repo: 'https://github.com/mikebrady/nqptp.git'
    dest: "{{ home }}/nqptp"
    clone: true
    update: true
  register: nqptp_repo
  tags: [shairport-sync, nqptp]

- name: Configure nqptp installation
  ansible.builtin.shell:
    cmd: autoreconf -fi && ./configure --with-systemd-startup
    chdir: "{{ home }}/nqptp/"
  when: nqptp_repo.before != nqptp_repo.after
  tags: [shairport-sync, nqptp]

- name: Prepare nqptp installation
  community.general.make:
    chdir: "{{ home }}/nqptp/"
  when: nqptp_repo.before != nqptp_repo.after
  tags: [shairport-sync, nqptp]

- name: Install nqptp
  community.general.make:
    chdir: nqptp
    target: install
  when: nqptp_repo.before != nqptp_repo.after
  become: true
  tags: [shairport-sync, nqptp]

- name: Enable nqptp service
  ansible.builtin.systemd:
    name: nqptp
    enabled: true
  become: true
  tags: [shairport-sync, nqptp, systemd]

- name: Start nqptp service
  ansible.builtin.systemd:
    name: nqptp
    state: started
  become: true
  tags: [shairport-sync, nqptp, systemd]

- name: Clone shairport-sync repo  # noqa: latest
  ansible.builtin.git:
    repo: 'https://github.com/mikebrady/shairport-sync.git'
    dest: "{{ home }}/shairport-sync"
    clone: true
    update: true
  register: shairport_repo
  tags: [shairport-sync]

- name: Configure shairport-sync installation
  ansible.builtin.shell:
    cmd: |
      autoreconf -fi && ./configure --sysconfdir=/etc \
                                    --with-alsa \
                                    --with-soxr \
                                    --with-avahi \
                                    --with-ssl=openssl \
                                    --with-systemd \
                                    --with-airplay-2
    chdir: "{{ home }}/shairport-sync/"
  when: shairport_repo.before != shairport_repo.after
  tags: [shairport-sync]

- name: Prepare shairport-sync installation
  community.general.make:
    chdir: "{{ home }}/shairport-sync/"
  when: shairport_repo.before != shairport_repo.after
  tags: [shairport-sync]

- name: Install shairport-sync
  community.general.make:
    chdir: shairport-sync
    target: install
  when: shairport_repo.before != shairport_repo.after
  become: true
  tags: [shairport-sync]

- name: Configure shairport-sync
  ansible.builtin.template:
    src: shairport-sync.conf
    dest: /etc/shairport-sync.conf
  become: true
  notify:
    - restart shairport-sync
  tags: [shairport-sync]

- name: Start shairport-sync service
  ansible.builtin.systemd:
    name: shairport-sync
    state: started
    enabled: true
    daemon_reload: true
  become: true
  tags: [shairport-sync, systemd]

- name: Check WIFI config
  ansible.builtin.command: iwconfig wlan0
  register: wifi_config
  become: true
  changed_when: false
  tags: [shairport-sync, wifi]

- name: Turn off power management for WIFI
  ansible.builtin.command: iwconfig wlan0 power off
  when: "'Power Management:on' in wifi_config.stdout"
  become: true
  tags: [shairport-sync, wifi]
